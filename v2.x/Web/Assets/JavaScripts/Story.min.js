var Story={_retrieveStoryUrl:"",_suggestTagsUrl:"",_clickUrl:"",_promoteUrl:"",_demoteUrl:"",_markAsSpamUrl:"",_lastRetrievedUrl:"",_autoDiscover:false,_captchaEnabled:false,_isPreviewOpen:true,set_retrieveStoryUrl:function(A){Story._retrieveStoryUrl=A},set_suggestTagsUrl:function(A){Story._suggestTagsUrl=A},set_clickUrl:function(A){Story._clickUrl=A},set_promoteUrl:function(A){Story._promoteUrl=A},set_demoteUrl:function(A){Story._demoteUrl=A},set_markAsSpamUrl:function(A){Story._markAsSpamUrl=A},set_autoDiscover:function(A){Story._autoDiscover=A},set_captchaEnabled:function(A){Story._captchaEnabled=A},init:function(){$("#lnkStoryPreview").click(function(){if(Story._isPreviewOpen){$("#storyPreview").slideUp("normal");$("#lnkStoryPreview").text("show preview");Story._isPreviewOpen=false}else{$("#storyPreview").slideDown("normal");$("#lnkStoryPreview").text("hide preview");Story._isPreviewOpen=true}});RichEditor.create($("#txtStoryDescription"),$("#hidDescription"),$("#storyPreview"));$("#frmStorySubmit").validate({rules:{url:{required:true,url:true},title:{required:true,maxlength:256},storyDescription:{required:true,rangelength:[8,2048]},category:"required"},messages:{url:{required:"Url cannot be blank.",url:"Invalid url format."},title:{required:"Title cannot be blank.",maxlength:"Title cannot be more than 256 character."},storyDescription:{required:"Description cannot be blank.",rangelength:"Description must be between 8 to 2048 character."},category:"Category must be selected."},submitHandler:function(form){var options={dataType:"json",beforeSubmit:function(values,form,options){$("#storyMessage").text("").css("color","").hide();$U.disableInputs("#frmStorySubmit",true);$U.showProgress("Submitting Story...","#btnStorySubmit")},success:function(result){$U.disableInputs("#frmStorySubmit",false);$U.hideProgress();if(result.isSuccessful){window.location=result.url}else{html=result.errorMessage;if(result.url){html='Story with the same url already exists. <a href="'+result.url+'">Click here</a> to view the story.'}$("#storyMessage").html(html).css("color","#ff0000").show()}}};$(form).ajaxSubmit(options);return false},errorPlacement:function(error,element){findErrorElement(element).text(error.text())},highlight:function(element,errorClass){findErrorElement($(element)).show()},unhighlight:function(element,errorClass){findErrorElement($(element)).hide()}});function findErrorElement(element){var t=element.parents("p:first").find("span.error");if((t.length==0)&&(Membership.get_isLoggedIn())&&(Story._captchaEnabled)){t=element.parents("div#recaptcha_area").find("span.error")}return t}if((Membership.get_isLoggedIn())&&(Story._captchaEnabled)){var timerId=setInterval(function(){if(($("#recaptcha_area").length>0)&&($("#recaptcha_response_field").length>0)){$('<span class="error"></span>').appendTo("#recaptcha_area");$("#recaptcha_response_field").attr("title","Captcha verfication words cannot be blank.").rules("add",{required:true});window.clearInterval(timerId)}},500)}var txtStoryUrl=$("#txtStoryUrl");txtStoryUrl.blur(function(){Story._urlChanged()});Story._lastRetrievedUrl=txtStoryUrl.val();$("#txtStoryTags").autocomplete({url:Story._suggestTagsUrl,multiple:true,max:10,delay:50,scrollHeight:330,parse:function(data){return $.map(eval(data),function(row){return{data:row,value:row,result:row}})},formatItem:function(item){return item}});if(!Membership.get_isLoggedIn()){Membership.showLogin(true)}else{$U.focus("txtStoryUrl")}},dispose:function(){$("#lnkStoryPreview").unbind();$("#txtStoryDescription").unbind();$("#txtStoryUrl").unbind()},click:function(B){var A="id="+encodeURIComponent(B);$.ajax({url:Story._clickUrl,type:"POST",dataType:"json",data:A})},promote:function(B){if(!Membership.get_isLoggedIn()){Membership.showLogin(false);return }var A="id="+encodeURIComponent(B);$.ajax({url:Story._promoteUrl,type:"POST",dataType:"json",data:A,beforeSend:function(){$("#a-k-"+B).hide();$("#d-m-"+B).removeClass("inline").addClass("hide");$("#s-p-"+B).text("Wait...").show()},success:function(C){$("#s-p-"+B).text("").hide();if(C.isSuccessful){$("#s-p-"+B).parent().removeClass("do").addClass("undo");$("#s-c-"+B).hide().text(C.votes).fadeIn();$("#a-u-"+B).show()}else{$("#a-k-"+B).show();$("#d-m-"+B).show();$("#d-m-"+B).removeClass("hide").addClass("inline");$U.messageBox("Error",C.errorMessage,true)}}})},demote:function(B){if(!Membership.get_isLoggedIn()){Membership.showLogin(false);return }var A="id="+encodeURIComponent(B);$.ajax({url:Story._demoteUrl,type:"POST",dataType:"json",data:A,beforeSend:function(){$("#a-u-"+B).hide();$("#s-p-"+B).text("Wait...").show()},success:function(C){$("#s-p-"+B).text("").hide();if(C.isSuccessful){$("#s-p-"+B).parent().removeClass("undo").addClass("do");$("#s-c-"+B).hide().text(C.votes).fadeIn();$("#a-k-"+B).show();$("#d-m-"+B).removeClass("hide").addClass("inline")}else{$("#a-u-"+B).show();$U.messageBox("Error",C.errorMessage,true)}}})},markAsSpam:function(A){if(!Membership.get_isLoggedIn()){Membership.showLogin(false);return }function B(){var C="id="+encodeURIComponent(A);$.ajax({url:Story._markAsSpamUrl,type:"POST",dataType:"json",data:C,beforeSend:function(){$("#a-k-"+A).hide();$("#d-m-"+A).removeClass("inline").addClass("hide");$("#s-p-"+A).text("Wait...").show()},success:function(D){$("#s-p-"+A).text("").hide();if(D.isSuccessful){$("#s-p-"+A).parent().removeClass("do").addClass("none");$("#s-s-"+A).show();$("#t-"+A).fadeOut("normal",function(){$(this).remove()})}else{$("#a-k-"+A).show();$("#d-m-"+A).removeClass("hide").addClass("inline");$U.messageBox("Error",D.errorMessage,true)}}})}$U.confirm("Flag as Spam?","Are you sure you want to flag this story as spam?",B)},_urlChanged:function(){if(!Story._autoDiscover){return }var A=$("#txtStoryUrl");var D=$("#frmStorySubmit");if(D.validate().element(A)){if(Story._lastRetrievedUrl!=A.val()){var B="url="+encodeURIComponent(A.val());var C=$.ajax({url:Story._retrieveStoryUrl,dataType:"json",data:B,beforeSend:function(){$U.disableInputs("#frmStorySubmit",true);$U.showProgress('Retrieving content...<a id="cancelRetrive" class="actionLink" href="javascript:void(0)">cancel?</a>',"#txtStoryUrl");Story._lastRetrievedUrl=A.val();$("#cancelRetrive").click(function(){C.abort();$U.disableInputs("#frmStorySubmit",false);$U.focus("txtStoryTitle");$U.hideProgress();Story._lastRetrievedUrl=""})},success:function(E){$U.disableInputs("#frmStorySubmit",false);$U.focus("txtStoryTitle");$U.hideProgress();if(E.isSuccessful){$("#txtStoryTitle").val(E.title);$("#txtStoryDescription").val(E.description);D.validate().element($("#txtStoryTitle"));D.validate().element($("#txtStoryDescription"))}else{var F=E.errorMessage;if(E.alreadyExists){F='Story with the same url already exists. <a href="'+E.existingUrl+'">Click here</a> to view the story.'}$("#errorStoryUrl").html(F).show()}}})}}}};